<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Astro BOT Â· AI Code Weaver</title>
    
    <!-- Preload assets -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© (Ù†ÙØ³Ù‡Ø§) - Ø³Ù†Ø®ØªØµØ±Ù‡Ø§ Ù„Ù„Ø·ÙˆÙ„ Ù„ÙƒÙ† ÙŠØ¬Ø¨ ØªØ¶Ù…ÙŠÙ†Ù‡Ø§ ÙƒØ§Ù…Ù„Ø© ÙÙŠ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙØ¹Ù„ÙŠ */
        /* Ù‡Ù†Ø§ Ù†Ø¶Ø¹ ÙƒÙ„ Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚ØŒ ÙˆÙ„ÙƒÙ† Ù„Ù„Ø§Ø®ØªØµØ§Ø± Ø³Ø£ÙƒØªØ¨ "..." ÙÙŠ Ø§Ù„Ø´Ø±Ø­ØŒ Ù„ÙƒÙ† ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙŠØ¬Ø¨ ÙˆØ¶Ø¹Ù‡Ø§ ÙƒØ§Ù…Ù„Ø©. */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        #loader-screen { position: fixed; top:0; left:0; width:100%; height:100%; background:#000; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:9999; transition:opacity 0.3s; }
        .loader-spinner { width:60px; height:60px; border:5px solid #330000; border-top-color:#ff0000; border-radius:50%; animation:spin 1s linear infinite; margin-bottom:20px; }
        .loader-text { color:#fff; font-family:'Poppins',sans-serif; font-size:1.2rem; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #main-content { opacity:0; transition:opacity 0.3s; }
        body.loaded #loader-screen { opacity:0; pointer-events:none; }
        body.loaded #main-content { opacity:1; }
        body { background:#000; color:#fff; min-height:100vh; display:flex; align-items:center; justify-content:center; padding:16px; font-family:'Poppins',sans-serif; }
        .app-container { width:100%; max-width:600px; background:#0a0a0a; border-radius:32px; border:1px solid #ff0000; box-shadow:0 20px 40px rgba(255,0,0,0.15); overflow:hidden; padding:24px 20px 32px; }
        .app-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:24px; }
        .logo-area { display:flex; align-items:center; gap:12px; }
        .bot-icon { width:48px; height:48px; border-radius:50%; background:#ff0000; display:flex; align-items:center; justify-content:center; overflow:hidden; border:2px solid #fff; }
        .bot-icon img { width:100%; height:100%; object-fit:cover; }
        .bot-title h1 { font-size:1.6rem; font-weight:700; background:linear-gradient(135deg,#ff0000,#990000); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; line-height:1.2; }
        .bot-title span { font-size:0.75rem; color:#aaa; letter-spacing:1px; }
        .attempts-badge { background:#1e1e1e; border:1px solid #ff0000; border-radius:40px; padding:8px 14px; display:flex; align-items:center; gap:8px; font-size:0.8rem; font-weight:600; color:#fff; box-shadow:0 0 10px rgba(255,0,0,0.3); }
        .attempts-badge i { color:#ff0000; font-size:1rem; }
        .menu-wrapper { position:relative; margin-top:16px; margin-bottom:20px; }
        .menu-trigger { background:transparent; border:1px solid #ff0000; color:white; width:100%; padding:14px 20px; border-radius:50px; display:flex; align-items:center; justify-content:space-between; font-size:1rem; font-weight:600; cursor:pointer; transition:0.2s; backdrop-filter:blur(4px); }
        .menu-trigger:hover { background:rgba(255,0,0,0.1); border-color:#ff4444; }
        .menu-trigger i { color:#ff0000; transition:transform 0.3s; }
        .menu-trigger.active i { transform:rotate(180deg); }
        .dropdown-menu { position:absolute; top:calc(100% + 8px); left:0; width:100%; background:#111; border:1px solid #ff0000; border-radius:24px; padding:16px; display:none; flex-direction:column; gap:16px; z-index:100; box-shadow:0 20px 30px rgba(255,0,0,0.3); backdrop-filter:blur(8px); }
        .dropdown-menu.show { display:flex; }
        .menu-section { border-bottom:1px solid #333; padding-bottom:12px; }
        .menu-section:last-child { border-bottom:none; padding-bottom:0; }
        .menu-section h3 { color:#ff0000; font-size:0.9rem; text-transform:uppercase; letter-spacing:2px; margin-bottom:12px; }
        .lang-options { display:flex; flex-wrap:wrap; gap:10px; }
        .lang-chip { background:#1e1e1e; border:1px solid #333; border-radius:40px; padding:8px 16px; font-size:0.85rem; font-weight:600; color:#ccc; display:flex; align-items:center; gap:6px; cursor:default; transition:0.2s; }
        .lang-chip i { color:#ff0000; }
        .lang-chip:hover { border-color:#ff0000; color:#fff; }
        .code-type-chip { background:#1e1e1e; border:1px solid #333; border-radius:40px; padding:8px 16px; font-size:0.85rem; font-weight:600; color:#ccc; display:inline-flex; align-items:center; gap:6px; margin-right:8px; margin-bottom:8px; cursor:default; }
        .code-type-chip i { color:#ff0000; }
        .input-group { margin-bottom:20px; }
        .input-label { display:flex; align-items:center; gap:8px; margin-bottom:8px; color:#ff0000; font-weight:600; font-size:0.95rem; }
        .input-label i { font-size:1.1rem; }
        textarea, input { width:100%; background:#121212; border:2px solid #333; border-radius:20px; padding:16px 20px; color:#fff; font-size:1rem; transition:0.2s; outline:none; resize:vertical; font-family:'Poppins',monospace; }
        textarea:focus, input:focus { border-color:#ff0000; box-shadow:0 0 15px rgba(255,0,0,0.3); }
        textarea { min-height:150px; }
        .checking-indicator { display:flex; align-items:center; gap:12px; margin:16px 0 20px; padding:12px 16px; background:#1a1a1a; border-radius:50px; border-left:4px solid #ff0000; opacity:0; transition:opacity 0.2s; }
        .checking-indicator.show { opacity:1; }
        .spinner { width:24px; height:24px; border:3px solid rgba(255,0,0,0.2); border-top-color:#ff0000; border-radius:50%; animation:spin 0.8s linear infinite; }
        .checking-text { font-size:0.95rem; font-weight:500; color:#ff8888; }
        .send-btn { width:100%; background:#ff0000; color:#fff; border:none; border-radius:60px; padding:18px 24px; font-size:1.3rem; font-weight:700; display:flex; align-items:center; justify-content:center; gap:12px; cursor:pointer; transition:0.2s; border:1px solid #ff5555; margin-top:12px; opacity:0.7; pointer-events:none; }
        .send-btn.enabled { opacity:1; pointer-events:all; background:#ff1a1a; box-shadow:0 10px 25px rgba(255,0,0,0.5); }
        .send-btn.enabled:hover { background:#ff3333; transform:scale(1.02); }
        .send-btn i { font-size:1.4rem; }
        .error-message { color:#ff7777; background:#2a0000; border-radius:16px; padding:12px 16px; margin-top:20px; border:1px solid #ff0000; font-size:0.9rem; display:flex; align-items:center; gap:8px; }
        .success-toast { position:fixed; bottom:30px; left:50%; transform:translateX(-50%); background:#0f0f0f; border:2px solid #ff0000; border-radius:60px; padding:16px 24px; color:#fff; font-weight:600; display:flex; align-items:center; gap:12px; box-shadow:0 10px 30px rgba(255,0,0,0.5); z-index:10000; transition:opacity 0.3s, bottom 0.3s; opacity:0; pointer-events:none; max-width:90%; text-align:center; backdrop-filter:blur(8px); }
        .success-toast.show { opacity:1; pointer-events:none; bottom:40px; }
        .success-toast i { color:#ff0000; font-size:1.8rem; }
        .hidden { display:none; }
        .footer-note { margin-top:24px; text-align:center; font-size:0.7rem; color:#555; }
    </style>
</head>
<body>
    <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
    <div id="loader-screen">
        <div class="loader-spinner"></div>
        <div class="loader-text">Astro BOT Â· Loading...</div>
    </div>

    <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <div id="main-content">
        <div class="app-container">
            <!-- Ø§Ù„Ø±Ø£Ø³ Ù…Ø¹ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙˆØ§Ù„Ø¹Ø¯Ø§Ø¯ -->
            <div class="app-header">
                <div class="logo-area">
                    <div class="bot-icon">
                        <img src="https://raw.githubusercontent.com/lz-server/Astro_BOT/refs/heads/main/icon.png" 
                             alt="Astro BOT" 
                             onerror="this.src='https://via.placeholder.com/48/ff0000/ffffff?text=ğŸ¤–'">
                    </div>
                    <div class="bot-title">
                        <h1>ASTRO BOT</h1>
                        <span>AI CODE WEAVER</span>
                    </div>
                </div>
                <div class="attempts-badge" id="attemptsBadge">
                    <i class="fa-solid fa-clock"></i>
                    <span id="attemptsCount">2/2</span>
                </div>
            </div>

            <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© -->
            <div class="menu-wrapper">
                <button class="menu-trigger" id="menuTrigger">
                    <span><i class="fa-solid fa-code"></i>  Code & Language Options</span>
                    <i class="fa-solid fa-chevron-down"></i>
                </button>
                <div class="dropdown-menu" id="dropdownMenu">
                    <div class="menu-section">
                        <h3><i class="fa-solid fa-terminal"></i> CODE TYPES</h3>
                        <div>
                            <span class="code-type-chip"><i class="fa-brands fa-html5"></i> HTML</span>
                            <span class="code-type-chip"><i class="fa-brands fa-css3-alt"></i> CSS</span>
                            <span class="code-type-chip"><i class="fa-brands fa-js"></i> JavaScript</span>
                            <span class="code-type-chip"><i class="fa-brands fa-python"></i> Python</span>
                            <span class="code-type-chip"><i class="fa-solid fa-database"></i> SQL</span>
                        </div>
                    </div>
                    <div class="menu-section">
                        <h3><i class="fa-solid fa-language"></i> LANGUAGES</h3>
                        <div class="lang-options">
                            <span class="lang-chip"><i class="fa-solid fa-check"></i> English</span>
                            <span class="lang-chip">ğŸ‡ªğŸ‡¸ EspaÃ±ol</span>
                            <span class="lang-chip">ğŸ‡«ğŸ‡· FranÃ§ais</span>
                            <span class="lang-chip">ğŸ‡©ğŸ‡ª Deutsch</span>
                            <span class="lang-chip">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</span>
                            <span class="lang-chip">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ø­Ù‚Ù„ Ø§Ù„ÙƒÙˆØ¯ -->
            <div class="input-group">
                <div class="input-label">
                    <i class="fa-solid fa-code"></i> <span>Paste your code *</span>
                </div>
                <textarea id="codeInput" placeholder="&lt;?php echo 'Hello Astro'; ?&gt;  or  def hello(): ..." spellcheck="false"></textarea>
            </div>

            <!-- Ø­Ù‚Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· -->
            <div class="input-group">
                <div class="input-label">
                    <i class="fa-solid fa-link"></i> <span>Desired final URL *</span>
                </div>
                <input type="url" id="urlInput" placeholder="https://your-spoofed-link.com/page">
            </div>

            <!-- Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù‚Ù‚ -->
            <div class="checking-indicator" id="checkingIndicator">
                <div class="spinner"></div>
                <span class="checking-text" id="checkingText">Analyzing code structure...</span>
            </div>

            <!-- Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ -->
            <button class="send-btn" id="sendBtn" disabled>
                <i class="fa-solid fa-paper-plane"></i> EXECUTE SPOOF
            </button>

            <!-- Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ -->
            <div id="errorMsg" class="error-message hidden">
                <i class="fa-solid fa-circle-exclamation"></i> <span></span>
            </div>

            <!-- Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ -->
            <div id="successToast" class="success-toast">
                <i class="fa-solid fa-check-circle"></i>
                <span id="successMessage">Request sent! You'll receive the result within 24h.</span>
            </div>

            <!-- ØªØ°ÙŠÙŠÙ„ -->
            <div class="footer-note">
                âš¡ 2 attempts per 24h Â· high-speed AI core
            </div>
        </div>
    </div>

    <!-- Ù…ÙƒØªØ¨Ø© Telegram Web App -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script>
        (function() {
            // --- Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ ---
            function hideLoader() {
                document.body.classList.add('loaded');
            }
            window.addEventListener('load', function() {
                setTimeout(hideLoader, 300);
            });
            setTimeout(hideLoader, 3000);

            // --- ØªÙ‡ÙŠØ¦Ø© Telegram Web App ---
            const tg = window.Telegram?.WebApp;
            if (tg) {
                tg.expand();
                tg.enableClosingConfirmation();
                tg.setHeaderColor('#000000');
                tg.setBackgroundColor('#000000');
            }

            // --- Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙØ±ÙŠØ¯ ---
            function getUserId() {
                if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    return tg.initDataUnsafe.user.id.toString();
                }
                return 'guest';
            }

            const userId = getUserId();

            // --- Ø¹Ù†Ø§ØµØ± DOM ---
            const menuTrigger = document.getElementById('menuTrigger');
            const dropdownMenu = document.getElementById('dropdownMenu');
            const codeInput = document.getElementById('codeInput');
            const urlInput = document.getElementById('urlInput');
            const sendBtn = document.getElementById('sendBtn');
            const checkingIndicator = document.getElementById('checkingIndicator');
            const checkingText = document.getElementById('checkingText');
            const attemptsBadgeSpan = document.getElementById('attemptsCount');
            const errorMsgDiv = document.getElementById('errorMsg');
            const errorSpan = errorMsgDiv.querySelector('span');
            const successToast = document.getElementById('successToast');
            const successMessageSpan = document.getElementById('successMessage');

            // --- Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© ---
            let isChecking = false;
            let checkTimeout = null;
            let lastCodeLength = 0;
            let verificationPassed = false;

            // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª (Ø®Ø§ØµØ© Ø¨ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù…) ---
            const MAX_ATTEMPTS = 2;
            const HOURS_24 = 24 * 60 * 60 * 1000;

            function getUserStorageKey(uid) {
                return `astro_attempts_${uid}`;
            }

            function getAttempts(uid) {
                const key = getUserStorageKey(uid);
                const stored = localStorage.getItem(key);
                if (!stored) return [];
                try {
                    return JSON.parse(stored).filter(ts => (Date.now() - ts) < HOURS_24);
                } catch {
                    return [];
                }
            }

            function addAttempt(uid) {
                const attempts = getAttempts(uid);
                attempts.push(Date.now());
                const key = getUserStorageKey(uid);
                localStorage.setItem(key, JSON.stringify(attempts));
            }

            function remainingAttempts(uid) {
                const attempts = getAttempts(uid);
                return Math.max(0, MAX_ATTEMPTS - attempts.length);
            }

            function canSend(uid) {
                return remainingAttempts(uid) > 0;
            }

            function updateAttemptsDisplay(uid) {
                const remaining = remainingAttempts(uid);
                attemptsBadgeSpan.innerText = `${remaining}/${MAX_ATTEMPTS}`;
            }

            // --- Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ Ù…Ø¤Ù‚ØªØ© ---
            function showSuccessMessage(text) {
                successMessageSpan.innerText = text;
                successToast.classList.add('show');
                setTimeout(() => {
                    successToast.classList.remove('show');
                }, 4000);
            }

            // --- Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ØªØ­Ù‚Ù‚ ---
            function startChecking() {
                const code = codeInput.value.trim();
                const url = urlInput.value.trim();

                if (!code || !url) {
                    stopChecking(false);
                    return;
                }

                if (checkTimeout) clearTimeout(checkTimeout);

                const codeLength = code.length;
                lastCodeLength = codeLength;
                const checkTime = Math.min(3000, Math.max(800, codeLength * 2));

                checkingText.innerText = `Checking (${codeLength} chars) Â· simulating AI analysis...`;
                checkingIndicator.classList.add('show');
                sendBtn.classList.remove('enabled');
                sendBtn.disabled = true;
                verificationPassed = false;

                isChecking = true;

                checkTimeout = setTimeout(() => {
                    checkingIndicator.classList.remove('show');
                    sendBtn.classList.add('enabled');
                    sendBtn.disabled = false;
                    verificationPassed = true;
                    isChecking = false;
                    checkTimeout = null;
                }, checkTime);
            }

            function stopChecking(passed = false) {
                if (checkTimeout) {
                    clearTimeout(checkTimeout);
                    checkTimeout = null;
                }
                checkingIndicator.classList.remove('show');
                if (!passed) {
                    sendBtn.classList.remove('enabled');
                    sendBtn.disabled = true;
                    verificationPassed = false;
                }
                isChecking = false;
            }

            // --- Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ù†ØµÙŠ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡ Ø¥Ù„Ù‰ ØªÙŠÙ„ÙŠØºØ±Ø§Ù… ÙƒÙ€ Document Ù…Ø¹ ØªØ¹Ù„ÙŠÙ‚ ---
            async function sendCodeAsFile(chatId, code, caption) {
                const botToken = '7743775004:AAFSaZynQc1bY6Nxg9lzeQECQ3_Xwr1tj-0';
                
                // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† FormData Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ù
                const formData = new FormData();
                formData.append('chat_id', chatId);
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ù†ØµÙŠ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯
                const blob = new Blob([code], { type: 'text/plain' });
                const file = new File([blob], 'code.txt', { type: 'text/plain' });
                formData.append('document', file);
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ (caption) Ø¥Ø°Ø§ ÙˆØ¬Ø¯
                if (caption) {
                    formData.append('caption', caption);
                    formData.append('parse_mode', 'Markdown');
                }

                const apiUrl = `https://api.telegram.org/bot${botToken}/sendDocument`;
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();
                    if (!data.ok) {
                        if (data.description && data.description.includes('chat not found')) {
                            throw new Error('CHAT_NOT_FOUND');
                        }
                        throw new Error(data.description || 'Telegram API error');
                    }
                    return data;
                } catch (error) {
                    console.error('Send file error:', error);
                    throw error;
                }
            }

            // --- Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø·ÙˆØ± ÙˆØ§Ù„Ù…Ø³ØªØ®Ø¯Ù… ---
            async function sendRequest(code, url, uid) {
                const developerChatId = 1484010221; // Ø§Ù„Ù…Ø·ÙˆØ±
                const botToken = '7743775004:AAFSaZynQc1bY6Nxg9lzeQECQ3_Xwr1tj-0'; // Ø¨ÙˆØª Astro BOT

                // Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
                const remainingBefore = remainingAttempts(uid);

                // Ø¥Ù†Ø´Ø§Ø¡ Ù†Øµ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ (caption) Ù„Ù„Ù…Ù„Ù Ø§Ù„Ø°ÙŠ Ø³ÙŠØ±Ø³Ù„
                const captionForDev = `ğŸš€ **New Spoof Request**\n\n` +
                                       `ğŸ‘¤ **User ID:** \`${uid}\`\n` +
                                       `ğŸ“… **Time:** ${new Date().toLocaleString()}\n` +
                                       `ğŸ¯ **Remaining attempts (before this):** ${remainingBefore}/${MAX_ATTEMPTS}\n\n` +
                                       `ğŸ”— **Target URL:** ${url}\n\n` +
                                       `ğŸ“ **Code is attached as file (code.txt)**`;

                const captionForUser = `âœ… **Your request has been received!**\n\n` +
                                        `ğŸ“… **Time:** ${new Date().toLocaleString()}\n` +
                                        `ğŸ”— **Target URL:** ${url}\n` +
                                        `ğŸ¯ **Remaining attempts (after this):** ${remainingBefore - 1}/${MAX_ATTEMPTS}\n\n` +
                                        `ğŸ“ **Your code is attached below.**\n` +
                                        `_You will receive the result within 24 hours._`;

                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø·ÙˆØ± Ø£ÙˆÙ„Ø§Ù‹
                await sendCodeAsFile(developerChatId, code, captionForDev);

                // Ø¥Ø°Ø§ Ù†Ø¬Ø­ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø·ÙˆØ±ØŒ Ù†Ø­Ø§ÙˆÙ„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ÙŠØ³ 'guest' Ø£Ùˆ Ø±Ù‚Ù… Ø­Ù‚ÙŠÙ‚ÙŠ)
                if (uid !== 'guest' && !isNaN(parseInt(uid))) {
                    try {
                        await sendCodeAsFile(parseInt(uid), code, captionForUser);
                    } catch (userError) {
                        // ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… - Ù†Ø³Ø¬Ù„ Ø§Ù„Ø®Ø·Ø£ ÙˆÙ„ÙƒÙ† Ù„Ø§ Ù†ÙˆÙ‚Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
                        console.warn('Failed to send to user:', userError);
                        // ÙŠÙ…ÙƒÙ† Ø¥Ø¸Ù‡Ø§Ø± ØªØ­Ø°ÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙ„ÙƒÙ† Ù„Ø§ Ù†Ø¹Ø·Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
                        showError('âš ï¸ Request sent to developer, but confirmation message failed to reach you. Please ensure you have started the bot.');
                    }
                }
            }

            // --- Ù…Ø¹Ø§Ù„Ø¬ Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ---
            sendBtn.addEventListener('click', async function(e) {
                e.preventDefault();

                if (!canSend(userId)) {
                    showError('â³ You have used both attempts for today. Please wait 24 hours.');
                    return;
                }

                if (!verificationPassed) {
                    showError('âŒ Please wait for code verification to complete.');
                    return;
                }

                const code = codeInput.value.trim();
                const url = urlInput.value.trim();

                if (!code || !url) {
                    showError('âš ï¸ Both code and URL are required.');
                    return;
                }

                // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± Ù…Ø¤Ù‚ØªØ§Ù‹
                sendBtn.disabled = true;
                sendBtn.classList.remove('enabled');
                const originalText = sendBtn.innerHTML;
                sendBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> SENDING...';

                try {
                    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ (Ù…Ù„Ù + Ø±Ø³Ø§Ø¦Ù„)
                    await sendRequest(code, url, userId);
                    
                    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­ (Ù†Ø¹ØªØ¨Ø± Ø§Ù„Ù†Ø¬Ø§Ø­ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø·ÙˆØ±)
                    addAttempt(userId);

                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                    updateAttemptsDisplay(userId);

                    // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
                    showSuccessMessage('âœ… Request sent! You\'ll receive the result within 24h.');

                    // Ø§Ø®ØªÙŠØ§Ø±ÙŠØ§Ù‹: Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
                    // codeInput.value = '';
                    // urlInput.value = '';
                    // stopChecking(false);
                    
                } catch (err) {
                    console.error(err);
                    if (err.message === 'CHAT_NOT_FOUND') {
                        const botUsername = 'Astro_TM_BOT'; // ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ø¨ÙˆØª
                        showError(`âŒ Please start a chat with @${botUsername} first (send /start), then try again.`);
                        if (tg) {
                            tg.openTelegramLink(`https://t.me/${botUsername}`);
                        }
                    } else {
                        showError(`âŒ Failed to send: ${err.message}`);
                    }
                } finally {
                    sendBtn.innerHTML = originalText;
                    // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø± Ø¥Ø°Ø§ Ø¨Ù‚ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙˆÙƒØ§Ù† Ø§Ù„ØªØ­Ù‚Ù‚ Ø³Ø§Ø±ÙŠØ§Ù‹
                    if (verificationPassed && canSend(userId)) {
                        sendBtn.disabled = false;
                        sendBtn.classList.add('enabled');
                    } else {
                        sendBtn.disabled = true;
                        sendBtn.classList.remove('enabled');
                    }
                }
            });

            // --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ---
            function showError(msg) {
                errorSpan.innerText = msg;
                errorMsgDiv.classList.remove('hidden');
                setTimeout(() => {
                    errorMsgDiv.classList.add('hidden');
                }, 5000);
            }

            function handleInputChange() {
                const code = codeInput.value.trim();
                const url = urlInput.value.trim();

                if (!code || !url) {
                    stopChecking(false);
                    return;
                }

                if (code.length !== lastCodeLength || !verificationPassed) {
                    startChecking();
                }
            }

            codeInput.addEventListener('input', handleInputChange);
            urlInput.addEventListener('input', function() {
                if (codeInput.value.trim() && this.value.trim()) {
                    handleInputChange();
                } else {
                    stopChecking(false);
                }
            });

            codeInput.addEventListener('paste', function() {
                setTimeout(handleInputChange, 50);
            });

            menuTrigger.addEventListener('click', function() {
                dropdownMenu.classList.toggle('show');
                menuTrigger.classList.toggle('active');
            });

            document.addEventListener('click', function(event) {
                if (!menuTrigger.contains(event.target) && !dropdownMenu.contains(event.target)) {
                    dropdownMenu.classList.remove('show');
                    menuTrigger.classList.remove('active');
                }
            });

            // --- Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ---
            updateAttemptsDisplay(userId);

            if (codeInput.value.trim() && urlInput.value.trim()) {
                startChecking();
            }

            document.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                }
            });

            window.onerror = function(message) {
                console.error('Global error:', message);
                return false;
            };
        })();
    </script>
</body>
</html>